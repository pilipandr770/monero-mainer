name: Build CryptoNight WASM
# trigger: correct cn implementation

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-xmrig-wasm.yml'
      - 'wasm_src/**'

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Verify Emscripten
        run: emcc --version

      # ---- Download Monero crypto source files ----
      - name: Download Monero hash functions
        run: |
          mkdir -p monero_crypto
          BASE="https://raw.githubusercontent.com/monero-project/monero/master/src/crypto"
          COMMON="https://raw.githubusercontent.com/monero-project/monero/master/src/common"

          echo "=== Downloading hash function sources ==="
          # Blake-256
          curl -fSL "$BASE/blake256.c"       -o monero_crypto/blake256.c
          curl -fSL "$BASE/blake256.h"       -o monero_crypto/blake256.h

          # Groestl-256
          curl -fSL "$BASE/groestl.c"        -o monero_crypto/groestl.c
          curl -fSL "$BASE/groestl.h"        -o monero_crypto/groestl.h
          curl -fSL "$BASE/groestl_tables.h" -o monero_crypto/groestl_tables.h

          # JH-256
          curl -fSL "$BASE/jh.c"             -o monero_crypto/jh.c
          curl -fSL "$BASE/jh.h"             -o monero_crypto/jh.h

          # Skein-256 (uses Skein-512 internally for 256-bit output)
          curl -fSL "$BASE/skein.c"          -o monero_crypto/skein.c
          curl -fSL "$BASE/skein.h"          -o monero_crypto/skein.h
          curl -fSL "$BASE/skein_port.h"     -o monero_crypto/skein_port.h

          # Utility headers needed by hash functions
          curl -fSL "$COMMON/int-util.h"     -o monero_crypto/int-util.h
          curl -fSL "$COMMON/warnings.h"     -o monero_crypto/warnings.h

          echo "=== Downloaded files ==="
          ls -la monero_crypto/

      # ---- Create stub headers for missing dependencies ----
      - name: Create stub headers
        run: |
          # blake256.c includes <memwipe.h> (from epee submodule)
          cat > monero_crypto/memwipe.h << 'STUBEOF'
          #pragma once
          #include <string.h>
          static inline void memwipe(void *ptr, size_t n) {
              volatile unsigned char *p = (volatile unsigned char *)ptr;
              while (n--) *p++ = 0;
          }
          STUBEOF

          # Compatibility defines for WASM (little-endian, 32-bit pointers)
          cat > monero_crypto/wasm_compat.h << 'COMPATEOF'
          #pragma once
          #include <stdint.h>
          #ifndef SWAP32LE
          #define SWAP32LE(x) (x)
          #endif
          #ifndef SWAP64LE
          #define SWAP64LE(x) (x)
          #endif
          #ifndef u32BIG
          #define u32BIG(x) \
              ((((x) & 0x000000ffU) << 24) | (((x) & 0x0000ff00U) << 8) | \
               (((x) & 0x00ff0000U) >> 8)  | (((x) & 0xff000000U) >> 24))
          #endif
          COMPATEOF

          echo "=== Stub headers created ==="

      # ---- Compile CryptoNight WASM ----
      - name: Build CryptoNight WASM
        run: |
          mkdir -p wasm_build

          echo "=== Compiling CryptoNight WASM ==="
          emcc \
            -include monero_crypto/wasm_compat.h \
            -I monero_crypto \
            wasm_src/cryptonight_impl.c \
            monero_crypto/blake256.c \
            monero_crypto/groestl.c \
            monero_crypto/jh.c \
            monero_crypto/skein.c \
            -O2 \
            -s WASM=1 \
            -s MODULARIZE=1 \
            -s EXPORT_NAME='CryptoNight' \
            -s EXPORTED_FUNCTIONS='["_cn_hash","_try_hash","_get_memory_size","_malloc","_free"]' \
            -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap","HEAPU8"]' \
            -s TOTAL_MEMORY=67108864 \
            -s ALLOW_MEMORY_GROWTH=0 \
            -s NO_EXIT_RUNTIME=1 \
            -s ENVIRONMENT='web,worker' \
            -o wasm_build/cryptonight.js

          echo "=== Build output ==="
          ls -lh wasm_build/cryptonight.*

      - name: Copy to static
        run: |
          mkdir -p static/wasm
          cp wasm_build/cryptonight.js  static/wasm/
          cp wasm_build/cryptonight.wasm static/wasm/
          echo "=== WASM files ==="
          ls -lh static/wasm/
          echo "WASM size: $(wc -c < static/wasm/cryptonight.wasm) bytes"

      - name: Commit WASM files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add static/wasm/cryptonight.js static/wasm/cryptonight.wasm
          git diff --cached --stat
          git commit -m "chore(wasm): build CryptoNight from Monero source [correct hashes]" || echo "Nothing to commit"
          git push origin HEAD:main || echo "Push failed - check permissions"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload WASM artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cryptonight-wasm
          path: |
            wasm_build/cryptonight.js
            wasm_build/cryptonight.wasm
          if-no-files-found: warn