<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineWithMe ‚Äî –î–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π –º–∞–π–Ω–∏–Ω–≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –º–∞–π–Ω–µ—Ä -->
    <script src="{{ url_for('static', filename='js/webminer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/xmrig-adapter.js') }}"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white min-h-screen">
    
    <div class="container mx-auto px-4 py-12">
        <h1 class="text-5xl font-bold text-center mb-4">MineWithMe</h1>
        <p class="text-center text-gray-300 mb-6">
            –î–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –º–∞–π–Ω–∏–Ω–≥ Monero. –¢—ã —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—à—å –º–æ—â–Ω–æ—Å—Ç—å, –º—ã –±–µ—Ä—ë–º 15% –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ.
        </p>
        <p class="text-center text-gray-300 mb-6 text-sm">
            <strong>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</strong> CryptoNight WASM —Ö–µ—à–µ—Ä + WebSocket Stratum –ø—Ä–æ–∫—Å–∏ ‚Üí –ø—É–ª MoneroOcean ‚Üí –≤—ã–ø–ª–∞—Ç—ã –Ω–∞ XMR –∫–æ—à–µ–ª—ë–∫. 
            –ï—Å–ª–∏ WASM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–µ–º–æ-—Å–∏–º—É–ª—è—Ç–æ—Ä (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç).
        </p>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–≥–ª–∞—Å–∏—è -->
        <div id="consentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-8 max-w-lg">
                <h2 class="text-2xl font-bold mb-4">–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –º–∞–π–Ω–∏–Ω–≥</h2>
                <p class="text-gray-300 mb-4">
                    –°–∞–π—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ <span id="cpuDisplay">30</span>% —Ç–≤–æ–µ–≥–æ CPU. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.
                </p>

                <!-- –ö–æ—à–µ–ª—ë–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="mb-4">
                    <label class="block text-sm mb-2 text-purple-300 font-semibold">üí∞ –¢–≤–æ–π XMR –∫–æ—à–µ–ª—ë–∫ (85% –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è —Ç–µ–±–µ):</label>
                    <input type="text" id="userWallet" placeholder="4... –∏–ª–∏ 8... (95 —Å–∏–º–≤–æ–ª–æ–≤)" 
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-sm font-mono 
                                  focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none"
                           spellcheck="false" autocomplete="off">
                    <p id="walletError" class="text-red-400 text-xs mt-1 hidden">–í–≤–µ–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π XMR –∞–¥—Ä–µ—Å (95 —Å–∏–º–≤–æ–ª–æ–≤, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 4 –∏–ª–∏ 8)</p>
                    <p class="text-gray-500 text-xs mt-1">–ë–µ–∑ –∫–æ—à–µ–ª—å–∫–∞ ‚Äî 100% –º–∞–π–Ω–∏–Ω–≥ –∏–¥—ë—Ç –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm mb-2">–£—Ä–æ–≤–µ–Ω—å –Ω–∞–≥—Ä—É–∑–∫–∏:</label>
                    <input type="range" id="cpuSlider" min="10" max="100" value="30" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span id="cpuValue" class="text-purple-400 font-bold">30%</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="startMining()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold transition">
                        –ù–ê–ß–ê–¢–¨ –ú–ê–ô–ù–ò–ù–ì
                    </button>
                    <button onclick="closeModal()" 
                            class="flex-1 bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg transition">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controls" class="max-w-4xl mx-auto bg-gray-800 bg-opacity-50 backdrop-blur rounded-lg p-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-lg">‚óè –ú–∞–π–Ω–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω</span>
                    <span id="minerType" class="ml-4 text-sm text-gray-300">(—Ä–µ–∂–∏–º: demo)</span>
                </div>
                <button onclick="stopMining()" 
                        class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg transition">
                    –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <!-- Wallet info -->
            <div id="walletInfo" class="mb-6 bg-gray-700 bg-opacity-30 rounded-lg p-3 text-sm hidden">
                <div id="walletInfoUser" class="text-green-300 mb-1"></div>
                <div id="walletInfoDev" class="text-gray-400"></div>
                <div id="walletInfoMode" class="text-purple-300 mt-1 font-semibold"></div>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">–•–µ—à—Ä–µ–π—Ç</div>
                    <div id="hashrate" class="text-3xl font-bold text-purple-400">0 H/s</div>
                </div>
                <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">–®–∞—Ä—ã</div>
                    <div id="shares" class="text-3xl font-bold text-blue-400">0</div>
                </div>
                <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">‚âà XMR –≤ –¥–µ–Ω—å</div>
                    <div id="earnings" class="text-3xl font-bold text-green-400">0.0000</div>
                </div>
            </div>
            
            <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="text-center text-gray-400 border-t border-gray-700 pt-4">
                –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:
                <span id="globalStats" class="text-white font-semibold">0 MH/s ‚Ä¢ 0 —à–∞—Ä–æ–≤ ‚Ä¢ ‚âà 0 XMR</span>
            </div>
        </div>
    </div>

    <script>
        let miner = null;
        let cpuThrottle = 70;
        let totalShares = 0;
        let demoHashrate = 0;
        let demoShares = 0;
        let miningInterval = null;
        let userWalletAddress = '';

        document.getElementById('cpuSlider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('cpuValue').textContent = value + '%';
            document.getElementById('cpuDisplay').textContent = value;
            cpuThrottle = 100 - value;
        });

        function validateXmrWallet(addr) {
            if (!addr || addr.trim() === '') return true; // empty is ok (donation mode)
            addr = addr.trim();
            if (addr.length < 90 || addr.length > 110) return false;
            if (!addr.startsWith('4') && !addr.startsWith('8')) return false;
            return /^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]+$/.test(addr);
        }

        async function startMining() {
            // Validate wallet
            const walletInput = document.getElementById('userWallet').value.trim();
            const walletErr = document.getElementById('walletError');
            
            if (walletInput && !validateXmrWallet(walletInput)) {
                walletErr.classList.remove('hidden');
                return;
            }
            walletErr.classList.add('hidden');
            userWalletAddress = walletInput;

            document.getElementById('consentModal').style.display = 'none';
            document.getElementById('controls').classList.remove('hidden');

            // Show wallet info
            const walletInfoEl = document.getElementById('walletInfo');
            if (userWalletAddress) {
                walletInfoEl.classList.remove('hidden');
                document.getElementById('walletInfoUser').textContent = 
                    'üí∞ –¢–≤–æ–π –∫–æ—à–µ–ª—ë–∫: ' + userWalletAddress.slice(0, 8) + '...' + userWalletAddress.slice(-6) + ' (85%)';
                document.getElementById('walletInfoDev').textContent = 
                    'üîß Dev fee: {{ xmr_wallet[:8] }}...{{ xmr_wallet[-6:] }} (15%)';
                document.getElementById('walletInfoMode').textContent = '‚õèÔ∏è –ö–∞–∂–¥—ã–µ ~100 —Å–µ–∫: 85—Å ‚Üí —Ç–µ–±–µ, 15—Å ‚Üí –ø—Ä–æ–µ–∫—Ç—É';
            } else {
                walletInfoEl.classList.remove('hidden');
                document.getElementById('walletInfoUser').textContent = '‚ö†Ô∏è –ö–æ—à–µ–ª—ë–∫ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî 100% –∏–¥—ë—Ç –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞';
                document.getElementById('walletInfoDev').textContent = 
                    'üîß –ö–æ—à–µ–ª—ë–∫ –ø—Ä–æ–µ–∫—Ç–∞: {{ xmr_wallet[:8] }}...{{ xmr_wallet[-6:] }}';
                document.getElementById('walletInfoMode').textContent = '';
            }
            
            const threads = navigator.hardwareConcurrency || 4;
            const throttle = cpuThrottle / 100;

            // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π WASM –º–∞–π–Ω–µ—Ä —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä
            if (window.RealWasmAvailable && window.RealMiner) {
                document.getElementById('minerType').textContent = '(—Ä–µ–∂–∏–º: real WASM)';
                try {
                    await window.RealMiner.start({ 
                        pool: '{{ pool_url }}', 
                        wallet: '{{ xmr_wallet }}',
                        userWallet: userWalletAddress,
                        threads, 
                        throttle 
                    });
                    miner = window.RealMiner;
                    console.log('‚úÖ –†–µ–∞–ª—å–Ω—ã–π WASM –º–∞–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω');
                } catch (e) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –º–∞–π–Ω–µ—Ä, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π', e);
                    document.getElementById('minerType').textContent = '(—Ä–µ–∂–∏–º: demo)';
                    startLocalMiner();
                }
            } else if (typeof LocalMiner !== 'undefined') {
                document.getElementById('minerType').textContent = '(—Ä–µ–∂–∏–º: demo)';
                startLocalMiner();
            } else {
                console.error('‚ùå –ú–∞–π–Ω–µ—Ä—ã –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã');
                startDemoMode();
            }

            setInterval(updateStats, 2000);
            setInterval(loadGlobalStats, 5000);
            console.log('üí∞ User wallet:', userWalletAddress || '(not set ‚Äî donation mode)');
            console.log('üîß Dev wallet:', '{{ xmr_wallet }}');
        }
        
        function startLocalMiner() {
            const threads = navigator.hardwareConcurrency || 4;
            const throttle = cpuThrottle / 100;
            try {
                miner = new LocalMiner({
                    pool: '{{ pool_url }}',
                    wallet: '{{ xmr_wallet }}',
                    worker: 'web' + Math.random().toString(36).substr(2, 9),
                    threads: threads,
                    throttle: throttle
                });
                miner.start();
                console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –º–∞–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω (CPU –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)');
            } catch (e) {
                console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞–π–Ω–µ—Ä, –≤–∫–ª—é—á–∞–µ–º –¥–µ–º–æ', e);
                startDemoMode();
            }
        }

        function startDemoMode() {
            const cpuPower = 100 - cpuThrottle;
            const baseHashrate = 150;
            miningInterval = setInterval(() => {
                demoHashrate = (baseHashrate * cpuPower / 100) + (Math.random() * 20 - 10);
                demoHashrate = Math.max(0, demoHashrate);
                if (Math.random() > 0.8) demoShares++;
            }, 2000);
        }

        function stopMining() {
            if (miner && typeof miner.stop === 'function') {
                miner.stop();
                miner = null;
            }
            if (miningInterval) {
                clearInterval(miningInterval);
                miningInterval = null;
            }
            demoHashrate = 0;
            demoShares = 0;
            totalShares = 0;
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('consentModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('consentModal').style.display = 'none';
        }

        function updateStats() {
            let hashrate = 0;
            let acceptedShares = 0;
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞–π–Ω–µ—Ä–∞
            if (miner && typeof miner.getHashrate === 'function') {
                hashrate = miner.getHashrate() || 0;
                acceptedShares = miner.getAcceptedShares() || 0;
            } else {
                // –î–µ–º–æ-—Ä–µ–∂–∏–º
                hashrate = demoHashrate;
                acceptedShares = demoShares;
            }
            
            document.getElementById('hashrate').textContent = hashrate.toFixed(2) + ' H/s';
            document.getElementById('shares').textContent = Math.floor(acceptedShares);
            const estimatedDaily = (hashrate * 0.0000001).toFixed(8);
            document.getElementById('earnings').textContent = estimatedDaily;

            if (acceptedShares > totalShares) {
                const newShares = acceptedShares - totalShares;
                totalShares = acceptedShares;
                fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hashrate: hashrate,
                        shares: newShares,
                        estimated: parseFloat(estimatedDaily)
                    })
                }).catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err));
            }
        }

        function loadGlobalStats() {
            fetch('/api/stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('globalStats').textContent = 
                        `${data.total_hashrate.toFixed(3)} MH/s ‚Ä¢ ${data.total_shares} —à–∞—Ä–æ–≤ ‚Ä¢ ‚âà ${data.estimated_xmr.toFixed(4)} XMR (dev: ${data.dev_fee_collected.toFixed(4)} XMR, gross: ${data.gross_estimated_xmr.toFixed(4)} XMR)`;
                });
        }

        loadGlobalStats();
    </script>

</body>
</html>
